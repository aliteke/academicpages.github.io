<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Testing AWS Bucket Data Plotting in Real Time</title>
      <link rel='icon' href='https://sunypoly.edu/sites/default/files/favy_0.png' type='image/x-icon'/ >
      <meta name="description" content="IoT Data Plotting from S3 Buckets">
      <meta name="author" content="a.t.">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!--FONT-->
      <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>
      <!--Scripts-->
      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.19.min.js"></script>
      <!--script src="js/raven-table-dashboard.js"></script-->
      <!--script src="js/Chart.js"></script-->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

      <!--Date Picker JQuery-->
      <script src="https://code.jquery.com/jquery-1.12.4.js"></script> 
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
      <link rel="stylesheet" href="/resources/demos/style.css">      

   </head>
   <body>
	<h1>Virginia Transportation Research Council - Smart Road Monitoring Project (SUNY Poly)</h1>
	<p id="demo"></p>
	<br>
	<br>
	
	<p>Start Date: <input type="text" id="startDatepicker"> End Date: <input type="text" id="endDatepicker"> <button id="buttonPlotDates">Plot Data within Dates</button> </p>
	<br>
	<br>
	
	<script>
		$( function() {
				$( "#startDatepicker" ).datepicker();
			}
		);
		$( function() {
				$( "#endDatepicker" ).datepicker();
			}
		)
		<!--Listener for the PlotDates Button-->
		document.getElementById('buttonPlotDates').addEventListener('click', function() {
				var startDate = document.getElementById("startDatepicker").value
				var endDate = document.getElementById("endDatepicker").value

				if(startDate == "" && endDate == ""){
					alert("Please choose a Start Date & End Date!!")
				}else if(startDate== ""){
					alert("Please choose a Start Date!")
				}else if(endDate== ""){
					alert("Please choose an End Date!")
				}else if(startDate > endDate){
					alert('Start Date should be before End Date!')
					document.getElementById("startDatepicker").value = ""
					document.getElementById("endDatepicker").value = ""
				}else{
					alert('You have chosen Start Date: '+ startDate + ", End Date: " + endDate)
					window.myTemperatureChart.data.labels.push("test-date")
					l = window.myTemperatureChart.data.datasets[0].data.length
					window.myTemperatureChart.data.datasets[0].data.push(new Object({x:l+1, y: l*2}))
					window.myTemperatureChart.update();
				}
			});

  		var text, parser, xmlDoc;
		var mycontent;
		var timestamps=[];
		var temps=[];
		var humids=[];

		url = "https://viginiadot.s3-us-west-2.amazonaws.com/"
		request = new XMLHttpRequest();
		request.open('GET', url, false);
		request.responseType = 'text/xml';
		
		request.send();
		mycontent = request.responseText;

		parser = new DOMParser();
		xmlDoc = parser.parseFromString(mycontent,"text/xml");

		mykeys = xmlDoc.getElementsByTagName("Key")
		
		console.log("Length of keys: " + mykeys.length)
		
		var x= ""; 
		for(i=0; i< mykeys.length; i++)
		{
			<!--searchKey="2019-11-14"-->
			<!--if(mykeys[i].textContent.startsWith( searchKey )) -->
			searchKey="2019-"
			if( i>= (mykeys.length - 15) && mykeys[i].textContent.startsWith( searchKey )){
				if(mykeys[i].nextSibling.nextSibling.nextSibling.textContent != "0"){
					x += (url + mykeys[i].textContent) + "<br>"; 
					cur_json_url = url + mykeys[i].textContent;
					console.log(cur_json_url);
					request.open('GET', cur_json_url, false);
					request.send();
					console.log(request.responseText);
					mycontent = JSON.parse(request.responseText);
					timestamps.push(mycontent["timestamp"]);
					temps.push(mycontent["temperature"]);
					humids.push(mycontent["humidity"]);
				}
			}
		}
		
		msg = "[+] Displaying last " + temps.length + " sensor records in S3 Bucket. <br>[+] Search Key (date starts with): " + searchKey + "<br>[+] total Temps: " + temps.length + ", total timestamps: " + timestamps.length + ", total humidities: " + humids.length
		document.getElementById("demo").innerHTML= msg
		
<!-- "Read the JSON from the S3 Bucket and put the Timestamp, Humidity and Temperature Values in Arrays"
		
		request = new XMLHttpRequest();
		url = "https://viginiadot.s3-us-west-2.amazonaws.com/2019-11-15_19-29-39"
	
		var myArr = ""	
		request.onreadystatechange = function () {
			console.log("[+] Ready State"+ this.readyState)
			if (this.readyState == 4){
				myArr= JSON.parse(this.responseText);
				console.log("Testing myArr: " + myArr);
			}
		}

		request.open('GET', url, true);
		request.send();
		mycontent = request.responseText;
-->
	</script>
	
	<div style="width:75%; margin: auto;">
		<canvas id="myChartTemperature"></canvas>
	</div>
	
	<div style="width:75%; margin: auto;">
		<canvas id="myChartHumidity"></canvas>
	</div>
	
	<script type="text/javascript">
		var temps2=[]
		for(i=0; i<temps.length; i++){ 
			o = new Object( { "x": i, "y": temps[i] } ); 
			temps2.push(o);
		}

		var configTemperatureChart = {
				type: 'line',
				data: {
					labels: timestamps,
        				datasets: [{
            					label: 'Temperature Sensor Values',
            					data: temps2,
            					backgroundColor: 'rgb(54, 162, 235)',
            					borderColor: 'rgb(255, 99, 132)',
            					borderWidth: 5,
						fill: false
			        	}
					]
    				},
				options: {
					responsive: true,
					title: {
						display: true,
						text: ''
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'Time in Seconds'
							}
					}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'Value ( \xB0C )' 
							}
						}]
					}
				}	
		};
		var ctx = document.getElementById('myChartTemperature').getContext('2d');
		window.myTemperatureChart = new Chart(ctx, configTemperatureChart);


		var configHumidityChart ={
                                type: 'line',
                                data: {
                                        labels: timestamps,
                                        datasets: [{
                                                label: 'Humidity Sensor Values',
                                                data: humids,
                                                backgroundColor: 'rgb(201, 203, 207)',
                                                borderColor: 'rgb(75, 192, 192)',
                                                borderWidth: 5,
                                                fill: false
                                        }
                                        ]
                                },
                                options: {
                                        responsive: true,
                                        title: {
                                                display: true,
                                                text: ''
                                        },
                                        tooltips: {
                                                mode: 'index',
                                                intersect: false,
                                        },
                                        hover: {
                                                mode: 'nearest',
                                                intersect: true
                                        },
                                        scales: {
                                                xAxes: [{
                                                        display: true,
                                                        scaleLabel: {
                                                                display: true,
                                                                labelString: 'Time in Seconds'
                                                        }
                                        }],
                                                yAxes: [{
                                                        display: true,
                                                        scaleLabel: {
                                                                display: true,
                                                                labelString: 'Value (%)'
                                                        }
                                                }]
                                        }
                                }
		};
		var ctx = document.getElementById('myChartHumidity').getContext('2d');
		window.myHumidityChart = new Chart(ctx, configHumidityChart);


	</script>
   </body>
</html>
