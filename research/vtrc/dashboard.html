<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Testing AWS Bucket Data Plotting in Real Time</title>
      <link rel='icon' href='https://sunypoly.edu/sites/default/files/favy_0.png' type='image/x-icon'/ >
      <meta name="description" content="IoT Data Plotting from S3 Buckets">
      <meta name="author" content="a.t.">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!--FONT-->
      <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>
      <!--Scripts-->
      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.19.min.js"></script>
      <!--script src="js/raven-table-dashboard.js"></script-->
      <!--script src="js/Chart.js"></script-->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

   </head>
   <body>
	<p id="demo"></p>

	<script>
		var text, parser, xmlDoc;
		var mycontent;
		var timestamps=[];
		var temps=[];
		var humids=[];

		url = "https://viginiadot.s3-us-west-2.amazonaws.com/"
		request = new XMLHttpRequest();
		request.open('GET', url, false);
		request.responseType = 'text/xml';
		
		request.send();
		mycontent = request.responseText;

		parser = new DOMParser();
		xmlDoc = parser.parseFromString(mycontent,"text/xml");

		mykeys = xmlDoc.getElementsByTagName("Key")
		
		console.log("Length of keys: " + mykeys.length)
		
		var x= ""; 
		for(i=0; i< mykeys.length; i++)
		{
			<!--searchKey="2019-11-14"-->
			<!--if(mykeys[i].textContent.startsWith( searchKey )) -->
			searchKey="2019-"
			if( i>= (mykeys.length - 15) && mykeys[i].textContent.startsWith( searchKey )){
				if(mykeys[i].nextSibling.nextSibling.nextSibling.textContent != "0"){
					x += (url + mykeys[i].textContent) + "<br>"; 
					cur_json_url = url + mykeys[i].textContent;
					console.log(cur_json_url);
					request.open('GET', cur_json_url, false);
					request.send();
					console.log(request.responseText);
					mycontent = JSON.parse(request.responseText);
					timestamps.push(mycontent["timestamp"]);
					temps.push(mycontent["temperature"]);
					humids.push(mycontent["humidity"]);
				}
			}
		}
		
		msg = "[+] Search Key (date starts with): " + searchKey + "<br>[+] total Temps: " + temps.length + ", total timestamps: " + timestamps.length + ", total humidities: " + humids.length
		document.getElementById("demo").innerHTML= msg
		
<!-- "Read the JSON from the S3 Bucket and put the Timestamp, Humidity and Temperature Values in Arrays"
		
		request = new XMLHttpRequest();
		url = "https://viginiadot.s3-us-west-2.amazonaws.com/2019-11-15_19-29-39"
	
		var myArr = ""	
		request.onreadystatechange = function () {
			console.log("[+] Ready State"+ this.readyState)
			if (this.readyState == 4){
				myArr= JSON.parse(this.responseText);
				console.log("Testing myArr: " + myArr);
			}
		}

		request.open('GET', url, true);
		request.send();
		mycontent = request.responseText;
-->
	</script>




	   TEST!!!
	   <div style="width:75%;">
		   <canvas id="myChart"></canvas>
	   </div>

	   <script type="text/javascript">
		var temps2=[]
		for(i=0; i<temps.length; i++){ 
			o = new Object( { "x": i, "y": temps[i] } ); 
			temps2.push(o);
		}

		var ctx = document.getElementById('myChart');
		var myChart = new Chart(ctx, {
			type: 'line',
		    	data: {
				labels: timestamps,
        			datasets: [{
            				label: 'Temperature Sensor Values',
            				data: temps2,
            				backgroundColor: 'rgb(54, 162, 235)',
            				borderColor: 'rgb(255, 99, 132)',
            				borderWidth: 1,
					fill: false
			        	},
				{
					label: 'Humidity Sensor Values',
					data: humids,
                                        backgroundColor: 'rgb(201, 203, 207)',
                                        borderColor: 'rgb(75, 192, 192)',
                                        borderWidth: 1,
                                        fill: false
				}
				]
    			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Virginia Transportation Research Council, Smart Road Monitoring Project'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Time in Seconds'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value'
						}
					}]
				}
			}	
		});
	</script>
   </body>
</html>
